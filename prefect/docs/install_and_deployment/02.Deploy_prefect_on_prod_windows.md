# Deploy prefect on prod on windows

In this doc, we will show how to deploy `Prefect` on production on a Windows server

## Pre-deployment checklist

Before the deployment steps, make sure you have the below items.

1. Windows server admin access
2. The right python interpreter version(3.11 or 3.12)
3. The `Prefect` python wheel package
4. The postgresql-15 server (or higher) . 
5. Prefect uses the [pg_trgm](https://www.postgresql.org/docs/current/pgtrgm.html) extension, so it must be installed and enabled on the postgresql server.

## Deployment steps

The below list shows the general `Prefect` deployment steps:
1. Create Service account for `security isolation`, `continuous uptime` and better `auditing`.
2. Install postgresql server with `pg_trgm` extension.(Dedicated service account to run postgresql)
3. Install python interpreter. (Dedicated service account to run Prefect)
4. Create virtual env, and install the prefect python package.
5. Configure and run prefect api server(setup server `data, log, conf dir` with env var, postgresql connection config)
6. Create a `work-pool` and run a `simple workflow`
7. Create a window service which runs the `Prefect Orion api server` and `worker` process.
8. Launch the `Prefect` service. 
9. Login with a user account, try to register a workflow and run it. check the output, and the task logs, etc..


## 1. Create service account.

We suppose the service account name which runs the prefect service is called `svc_prefect`. The postgresql server installer will
create a service account automatically. So we only create `svc_prefect` here.

```powershell
# 1. Create local account
New-LocalUser -Name "svc_prefect" -Password (Read-Host -AsSecureString "Enter password") -Description "Prefect service account"

# 2. Add 'Log on as a service' right
$account = "svc_prefect"
# export current local security policy into a plaintext configuration file (C:\secpol.cfg)
secedit /export /cfg C:\secpol.cfg
# modify the security policy by adding `*S-1-5-32-544`(the SID for the local Administrators group.)
(gc C:\secpol.cfg).Replace("SeServiceLogonRight =","SeServiceLogonRight = *S-1-5-32-544,$account") | Out-File C:\secpol.cfg
# after the above commands, in secpol.cfg, you should see the below lines
# SeServiceLogonRight = *S-1-5-32-544,svc_prefect

# import the modified security policy
secedit /import /cfg C:\secpol.cfg /db secedit.sdb
# Apply the policy immediately
gpupdate /force
# delete the temprary file
Remove-Item C:\secpol.cfg

# 3. Grant permissions
icacls D:\prefect_data /grant "svc_prefect:(OI)(CI)F"

```

## 2. Install postgresql server on windows

Prepare two directories to store the DB data and logs

```powershell
mkdir "D:\pgsql\data"
mkdir "D:\pgsql\logs"
```

> Replace the `D:` by a suitable `non-system drive` (D: or E:) for production.
> Ensure only the `PostgreSQL service account and Administrators` have modify rights:
> 
Below commands show an example of ACL setup.
```powershell
icacls D:\pgsql /inheritance:r /grant "Administrators:(OI)(CI)F" /grant "NT SERVICE\PostgreSQL:(OI)(CI)M"
```

### 2.1 Use EnterpriseDB installer (recommended)

1. Download the Windows installer matching your architecture (e.g., `postgresql-16-windows-x64.exe`).

2. Run it in **Administrator mode**.

3. Server config:
    - Installation directory: C:\Program Files\PostgreSQL\16
    - Data directory: D:\pgsql\data
    - Password: secure password for the postgres user
    - Port: 5432
    - Locale: default or en_US.UTF-8

4. Check the generated service
   - The installer automatically creates and registers the Windows service: `PostgreSQL Database Server 16` with startup type Automatic.
   - Verify the service: `Get-Service | Where-Object {$_.Name -like "*postgres*"}`

### 2.2 Configure postgresql for production

Edit `D:\pgsql\data\postgresql.conf`:

```ini
listen_addresses = 'localhost'
port = 5432
logging_collector = on
log_directory = 'D:/pgsql/logs'
log_filename = 'postgresql-%Y-%m-%d.log'
```

Edit `D:\pgsql\data\pg_hba.conf` to restrict access:

```powershell
# TYPE  DATABASE  USER      ADDRESS         METHOD
local   all       all                        scram-sha-256
host    prefect_db  prefect  127.0.0.1/32    scram-sha-256
```

Restart the service to apply the new conf

```powershell
net stop postgresql
net start postgresql
```

### 2.3 Create Prefect database and user

```powershell
# start a psql shell
cd "C:\Program Files\PostgreSQL\16\bin"
.\psql -U postgres

# run the below command to create prefect db and user
CREATE DATABASE prefect_db;
CREATE USER prefect WITH ENCRYPTED PASSWORD 'prefect_pass';
GRANT ALL PRIVILEGES ON DATABASE prefect_db TO prefect;
```

> Add the Prefect db connection string within `Prefect service account` : `setx /M PREFECT_API_DATABASE_CONNECTION_STRING "postgresql+psycopg2://prefect:prefect_pass@localhost:5432/prefect_db"`

### 2.4 Verify postgres service during Prefect launch

```powershell
# check service status
Get-Service postgresql

# view db log
Get-Content "D:\pgsql\logs\server.log" -Tail 20
```

### 2.5. Tuning the postgres server (optional)
If you need to increase the postgres server performance, you can edit the below params in `postgresql.conf`.

```powershell
shared_buffers = 2GB
work_mem = 64MB
maintenance_work_mem = 512MB
max_connections = 50
wal_level = replica
checkpoint_timeout = 15min

```

## 3. Install the python interpreter

Should have conda installed in the Windows server.

## 4. Create virtual env, and install the prefect python package.

The below commands should run under the `svc_prefect` service account.
