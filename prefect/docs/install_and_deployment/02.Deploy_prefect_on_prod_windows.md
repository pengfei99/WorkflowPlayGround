# Deploy prefect on prod on windows

In this doc, we will show how to deploy `Prefect` on production on a Windows server

## Pre-deployment checklist

Before the deployment steps, make sure you have the below items.

1. Windows server admin access
2. The right python interpreter version(3.11 or 3.12)
3. The `Prefect` python wheel package
4. The postgresql-15 server (or higher) . 
5. Prefect uses the [pg_trgm](https://www.postgresql.org/docs/current/pgtrgm.html) extension, so it must be installed and enabled on the postgresql server.

## Deployment steps

The below list shows the general `Prefect` deployment steps:
1. Create Service account for `security isolation`, `continuous uptime` and better `auditing`.
2. Install postgresql server with `pg_trgm` extension.(Dedicated service account to run postgresql)
3. Install python interpreter. (Dedicated service account to run Prefect)
4. Create virtual env, and install the prefect python package.
5. Configure and run prefect api server(setup server `data, log, conf dir` with env var, postgresql connection config)
6. Create a `work-pool` and run a `simple workflow`
7. Create a window service which runs the `Prefect Orion api server` and `worker` process.
8. Launch the `Prefect` service. 
9. Login with a user account, try to register a workflow and run it. check the output, and the task logs, etc..


## 1. Create service account.

We suppose the service account name which runs the prefect service is called `svc_prefect`. The postgresql server installer will
create a service account automatically. So we only create `svc_prefect` here.

```powershell
# 1. Create local account
New-LocalUser -Name "svc_prefect" -Password (Read-Host -AsSecureString "Enter password") -Description "Prefect service account"

# 2. Add 'Log on as a service' right
$account = "svc_prefect"
# export current local security policy into a plaintext configuration file (C:\secpol.cfg)
secedit /export /cfg C:\secpol.cfg
# modify the security policy by adding `*S-1-5-32-544`(the SID for the local Administrators group.)
(gc C:\secpol.cfg).Replace("SeServiceLogonRight =","SeServiceLogonRight = *S-1-5-32-544,$account") | Out-File C:\secpol.cfg
# after the above commands, in secpol.cfg, you should see the below lines
# SeServiceLogonRight = *S-1-5-32-544,svc_prefect

# import the modified security policy
secedit /import /cfg C:\secpol.cfg /db secedit.sdb
# Apply the policy immediately
gpupdate /force
# delete the temprary file
Remove-Item C:\secpol.cfg

# 3. Grant permissions
icacls D:\prefect_data /grant "svc_prefect:(OI)(CI)F"

# 4. If you also want to use it interactively (to open a shell session and install Python package):
net localgroup "Administrators" svc_prefect /add
# You need to remove it later after installation for security hardening.
net localgroup "Administrators" svc_prefect /delete
```

## 2. Install postgresql server on windows

Prepare two directories to store the DB data and logs

```powershell
mkdir "D:\pgsql\data"
mkdir "D:\pgsql\logs"
```

> Replace the `D:` by a suitable `non-system drive` (D: or E:) for production.
> Ensure only the `PostgreSQL service account and Administrators` have modify rights:
> 
Below commands show an example of ACL setup.
```powershell
icacls D:\pgsql /inheritance:r /grant "Administrators:(OI)(CI)F" /grant "NT SERVICE\PostgreSQL:(OI)(CI)M"
```

### 2.1 Use EnterpriseDB installer (recommended)

1. Download the Windows installer matching your architecture (e.g., `postgresql-16-windows-x64.exe`).

2. Run it in **Administrator mode**.

3. Server config:
    - Installation directory: C:\Program Files\PostgreSQL\16
    - Data directory: D:\pgsql\data
    - Password: secure password for the postgres user
    - Port: 5432
    - Locale: default or en_US.UTF-8

4. Check the generated service
   - The installer automatically creates and registers the Windows service: `PostgreSQL Database Server 16` with startup type Automatic.
   - Verify the service: `Get-Service | Where-Object {$_.Name -like "*postgres*"}`

### 2.2 Configure postgresql for production

Edit `D:\pgsql\data\postgresql.conf`:

```ini
listen_addresses = 'localhost'
port = 5432
logging_collector = on
log_directory = 'D:/pgsql/logs'
log_filename = 'postgresql-%Y-%m-%d.log'
```

Edit `D:\pgsql\data\pg_hba.conf` to restrict access:

```powershell
# TYPE  DATABASE  USER      ADDRESS         METHOD
local   all       all                        scram-sha-256
host    prefect_db  prefect  127.0.0.1/32    scram-sha-256
```

Restart the service to apply the new conf

```powershell
net stop postgresql
net start postgresql
```

### 2.3 Create Prefect database and user

```powershell
# start a psql shell
cd "C:\Program Files\PostgreSQL\16\bin"
.\psql -U postgres

# run the below command to create prefect db and user
CREATE DATABASE prefect_db;
CREATE USER prefect WITH ENCRYPTED PASSWORD 'prefect_pass';
GRANT ALL PRIVILEGES ON DATABASE prefect_db TO prefect;
```

> Add the Prefect db connection string within `Prefect service account` : `setx /M PREFECT_API_DATABASE_CONNECTION_STRING "postgresql+psycopg2://prefect:prefect_pass@localhost:5432/prefect_db"`

### 2.4 Verify postgres service during Prefect launch

```powershell
# check service status
Get-Service postgresql

# view db log
Get-Content "D:\pgsql\logs\server.log" -Tail 20
```

### 2.5. Tuning the postgres server (optional)
If you need to increase the postgres server performance, you can edit the below params in `postgresql.conf`.

```powershell
shared_buffers = 2GB
work_mem = 64MB
maintenance_work_mem = 512MB
max_connections = 50
wal_level = replica
checkpoint_timeout = 15min

```

## 3. Install the python interpreter

Should have conda installed in the Windows server.

## 4. Create virtual env, and install the prefect python package.

The below commands should run under the `svc_prefect` service account.

### 4.1 Open a shell as svc_prefect service account

```powershell
# open a shell as svc_prefect with runas
runas /user:svc_prefect cmd

# check the current user
whoami
# Expected output:
myserver\svc_prefect
```

> Now all actions (venv creation, python package install) happen inside this accountâ€™s profile.
> 
### 4.2 Create a python virtual env

```powershell
# create a virtual env
conda create --name prefect_env python --offline

conda activate prefect_env

# install prefect
pip install prefect==3.4.25

# after installation, check prefect
prefect version

# get python path
where python

# get prefect executable path
where prefect
```

> The current(25/10/2025) stable version is `3.4.25`.
> 
## 5. Configure and run prefect api server 

The best way to configure `Prefect` is to set up `env var`. We don't recommend you to modify the 

```powershell
setx /M PREFECT_HOME "D:\prefect_data"
setx /M PREFECT_API_URL "http://localhost:4200/api"
setx /M PREFECT_API_DATABASE_CONNECTION_STRING "postgresql+psycopg2://prefect:prefect_pass@localhost:5432/prefect_db"
```

> Ensure `D:\prefect_data` is writable by `svc_prefect`:
>
```powershell
icacls D:\prefect_data /grant "svc_prefect:(OI)(CI)M"
```

### 5.1 Start the prefect server manually

For testing purpose, we can run the prefect server with the below command

```powershell
# start prefect server
prefect server start
```

After the above command, you will have two services:
- **API**: runs on http://127.0.0.1:4200/api
- **Web UI**: runs on http://127.0.0.1:4200

> Leave this PowerShell window open
> 

## 6. Create a work-pool and run a simple workflow


### 6.1 Create a work-pool

```powershell
# create a work-pool
prefect work-pool create local-pool --type process

# start a worker which takes flow from a pool
prefect worker start --pool local-pool
```

### 6.2 Create a simple workflow

You can save the below script in a directory. In my case, I put it under `./flows/pengfei/simple_flow.py`

> The directory `flows/pengfei` should be accessible by admin and user pengfei. 

```python
from prefect import flow, task, get_run_logger

@task(log_prints=True)
def extract():
    data = [1, 2, 3]
    msg = f"Task1: Extracting data: {data}"
    logger = get_run_logger()
    logger.info(msg)
    print(msg)
    return data

@task(log_prints=True)
def transform(data):
    print(f"Task2: Transforming data: {data}")
    return [x * 10 for x in data]

@task(log_prints=True)
def load(data):
    print(f"Task3: Loading result {data}")

@flow
def etl_flow():
    # task 1
    data = extract()
    # task 2
    clean = transform(data)
    # task 3
    load(clean)


if __name__ == "__main__":
    etl_flow()
```

> This script uses both the print and logger to print info in the task logs
> 
You can run a workflow directly with the below command

```powershell
python ./flows/pengfei/simple_flow.py
```


## 7. Create a window service for Prefect

### 7.1 Create `Prefect` service startup scripts

Create a server startup script under `D:\prefect_data\scripts\start_server.ps1`

```powershell
$env:PREFECT_HOME = "D:\prefect_data"
$env:PREFECT_API_DATABASE_CONNECTION_STRING = "postgresql+psycopg2://prefect:prefect_pass@localhost:5432/prefect_db"
$env:PREFECT_LOGGING_SERVER_LEVEL = "INFO"
& "C:\Users\svc_prefect\prefect-env\Scripts\prefect.exe" orion start --host 0.0.0.0 --port 4200

```

Create a worker startup script under `D:\prefect_data\scripts\start_worker.ps1`

```powershell
$env:PREFECT_HOME = "D:\prefect_data"
$env:PREFECT_API_URL = "http://localhost:4200/api"
& "C:\Users\svc_prefect\prefect-env\Scripts\prefect.exe" worker start --pool shared_pool
```

Create `Windows Services` via **sc.exe**.

```powershell
# create service for server
sc create PrefectServer binPath= "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -NoProfile -ExecutionPolicy Bypass -File D:\prefect_data\scripts\start_server.ps1" start= auto obj= ".\svc_prefect" password= "StrongPwd!"

# create service for worker
sc create PrefectWorker binPath= "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -NoProfile -ExecutionPolicy Bypass -File D:\prefect_data\scripts\start_worker.ps1" start= auto obj= ".\svc_prefect" password= "StrongPwd!"

# check the created service
sc query PrefectServer
sc query PrefectWorker

# configure recovery and description
sc failure PrefectServer reset= 86400 actions= restart/5000
sc failure PrefectWorker reset= 86400 actions= restart/5000
sc description PrefectServer "Prefect 3 Server API Service"
sc description PrefectWorker "Prefect 3 Worker Service"
```

## 8. Launch the prefect service


```powershell

# start the service
net start PrefectServer
net start PrefectWorker

```

> Now you can check the Prefect Web UI: `http://localhost:4200`.


